<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摳摳守護者</title>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: white; width: 100%; max-width: 450px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 20px; box-sizing: border-box; }
        .main-balance { background: #1e293b; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; margin-top: 5px; }
        .balance-item { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .balance-item small { font-size: 12px; color: #94a3b8; }
        .balance-item div { font-size: 24px; font-weight: 800; }
        .days-left { position: absolute; top: 10px; right: 15px; font-size: 11px; color: #64748b; }
        .month-selector-group { margin-bottom: 15px; text-align: center; }
        select { padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; font-weight: bold; background: #fff; color: var(--primary); width: 100%; cursor: pointer; text-align-last: center; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #475569; }
        input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-btn { flex: 1; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; color: #64748b; }
        .type-btn.active-out { border-color: var(--danger); color: var(--danger); background: #fef2f2; }
        .type-btn.active-in { border-color: var(--success); color: var(--success); background: #f0fdf4; }
        button.main-submit { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; background: var(--primary); color: white; }
        .history { margin-top: 20px; border-top: 2px solid #f1f5f9; padding-top: 15px; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f8fafc; align-items: center; }
        .date-info { display: flex; flex-direction: column; flex-grow: 1; }
        .date-tag { font-size: 11px; color: #94a3b8; }
        .note-text { font-size: 15px; font-weight: 500; color: #334155; }
        .item-right { text-align: right; display: flex; align-items: center; gap: 10px; }
        .delete-btn { color: #cbd5e1; cursor: pointer; font-size: 18px; padding: 5px; border: none; background: none; }
        .txt-red { color: var(--danger); font-weight: bold; }
        .txt-green { color: var(--success); font-weight: bold; }
        .diff-tag { font-size: 12px; font-weight: bold; margin-left: 4px; }
        .diff-pos { color: var(--success); }
        .diff-neg { color: var(--danger); }
        .system-zone { margin-top: 40px; border-top: 2px solid #f1f5f9; padding-top: 15px; }
        .adjust-box { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px dashed #cbd5e1; margin-bottom: 15px; }
        .backup-btns { display: flex; gap: 8px; }
        .btn-small { flex: 1; padding: 8px; background: #f1f5f9; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <div class="month-selector-group">
        <select id="view-month" onchange="loadCurrentMonthSettings(); calculate()"></select>
    </div>

    <div class="main-balance">
        <span class="days-left" id="days-info"></span>
        <div class="balance-item">
            <small id="current-month-label">當前剩餘</small>
            <div id="actual-cash">$ 0</div>
        </div>
        <div class="balance-item" style="border-top: 1px solid #334155; padding-top: 10px; margin-top: 10px;">
            <small>自由基金</small>
            <div id="safety-balance" style="color: #63ffad;">$ 0</div>
        </div>
    </div>

    <div class="config-grid">
        <div class="input-group">
            <label>月預算</label>
            <input type="number" id="monthly-budget" placeholder="0" oninput="saveCurrentMonthSettings(); calculate()">
        </div>
        <div class="input-group">
            <label>日上限</label>
            <input type="number" id="daily-limit" placeholder="0" oninput="saveCurrentMonthSettings(); calculate()">
        </div>
    </div>

    <div class="input-group">
        <div class="type-selector">
            <button id="btn-out" class="type-btn active-out" onclick="setType('out')">支出 (紅)</button>
            <button id="btn-in" class="type-btn" onclick="setType('in')">收入 (綠)</button>
        </div>
        <input type="text" id="spend-note" placeholder="項目說明">
        <input type="number" id="spend-amount" placeholder="金額" style="margin-top:5px">
        <button class="main-submit" style="margin-top:10px" onclick="addRecord()">存入帳目</button>
    </div>

    <div class="history">
        <div id="history-list"></div>
    </div>
    
    <div class="system-zone">
        <div class="adjust-box">
            <label id="adjust-label" style="font-size: 12px; color: #64748b;">目前實際多少錢？</label>
            <div style="display: flex; gap: 8px; margin-top: 5px;">
                <input type="number" id="manual-adjust-val" placeholder="輸入實際金額" style="padding: 8px; font-size: 14px;">
                <button onclick="adjustBalance()" style="background: #64748b; color: white; border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; font-size: 13px; white-space: nowrap;">執行校準</button>
            </div>
        </div>
        <div class="backup-btns">
            <button class="btn-small" onclick="exportData()">備份</button>
            <button class="btn-small" onclick="importData()">匯入</button>
            <button class="btn-small" style="color:var(--danger)" onclick="clearData()">清空</button>
        </div>
    </div>
    <input type="file" id="importFile" style="display:none" onchange="handleFileSelect(event)">
</div>

<script>
    let records = JSON.parse(localStorage.getItem('budget_records_v12')) || [];
    let settings = JSON.parse(localStorage.getItem('budget_settings_v12')) || {}; // 格式: {"2025/12": {budget: 13000, limit: 300}}
    let currentType = 'out';
    let monthSpecificCash = 0;

    function initMonthSelector() {
        const selector = document.getElementById('view-month');
        const now = new Date();
        for (let i = 2; i > -12; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const val = `${d.getFullYear()}/${d.getMonth() + 1}`;
            const opt = document.createElement('option');
            opt.value = val; opt.innerText = val;
            if (i === 0) opt.selected = true;
            selector.appendChild(opt);
        }
    }

    // 讀取該月專屬設定
    function loadCurrentMonthSettings() {
        const selectedMonth = document.getElementById('view-month').value;
        const monthSetting = settings[selectedMonth];
        
        if (monthSetting) {
            document.getElementById('monthly-budget').value = monthSetting.budget;
            document.getElementById('daily-limit').value = monthSetting.limit;
        } else {
            // 如果這月沒設定過，預設為 0 或繼承上一次存過的全域預設值
            document.getElementById('monthly-budget').value = localStorage.getItem('global_budget_last') || "0";
            document.getElementById('daily-limit').value = localStorage.getItem('global_limit_last') || "0";
        }
    }

    // 儲存該月專屬設定
    function saveCurrentMonthSettings() {
        const selectedMonth = document.getElementById('view-month').value;
        const b = document.getElementById('monthly-budget').value;
        const l = document.getElementById('daily-limit').value;
        
        settings[selectedMonth] = { budget: b, limit: l };
        localStorage.setItem('budget_settings_v12', JSON.stringify(settings));
        
        // 同步存一份全域預設，給新月份繼承
        localStorage.setItem('global_budget_last', b);
        localStorage.setItem('global_limit_last', l);
    }

    function setType(type) {
        currentType = type;
        document.getElementById('btn-out').className = type === 'out' ? 'type-btn active-out' : 'type-btn';
        document.getElementById('btn-in').className = type === 'in' ? 'type-btn active-in' : 'type-btn';
    }

    function calculate() {
        const budget = parseFloat(document.getElementById('monthly-budget').value) || 0;
        const limit = parseFloat(document.getElementById('daily-limit').value) || 0;
        const selectedMonth = document.getElementById('view-month').value;
        const [year, month] = selectedMonth.split('/').map(Number);
        const lastDayOfMonth = new Date(year, month, 0).getDate();
        const today = new Date();
        const isCurrentMonth = (today.getFullYear() === year && (today.getMonth() + 1) === month);

        const filtered = records.filter(r => {
            const d = new Date(r.timestamp);
            return `${d.getFullYear()}/${d.getMonth() + 1}` === selectedMonth;
        });

        const totalOut = filtered.filter(r => r.type === 'out').reduce((sum, r) => sum + r.amount, 0);
        const totalIn = filtered.filter(r => r.type === 'in').reduce((sum, r) => sum + r.amount, 0);
        monthSpecificCash = budget + totalIn - totalOut;

        const daysRemaining = isCurrentMonth ? (lastDayOfMonth - today.getDate() + 1) : 0;
        const safetyBal = monthSpecificCash - (daysRemaining * limit);

        document.getElementById('current-month-label').innerText = month + "月當前剩餘";
        document.getElementById('adjust-label').innerText = month + "月實際有多少錢？";
        document.getElementById('actual-cash').innerText = `$ ${Math.round(monthSpecificCash).toLocaleString()}`;
        document.getElementById('safety-balance').innerText = `$ ${Math.round(safetyBal).toLocaleString()}`;
        document.getElementById('safety-balance').style.color = safetyBal >= 0 ? "#63ffad" : "#ff8787";
        document.getElementById('days-info').innerText = isCurrentMonth ? `本月剩餘 ${daysRemaining} 天` : "";

        renderHistory(filtered, limit);
    }

    function adjustBalance() {
        const targetVal = parseFloat(document.getElementById('manual-adjust-val').value);
        if (isNaN(targetVal)) return;
        const diff = targetVal - monthSpecificCash;
        if (diff === 0) return;
        const selectedMonth = document.getElementById('view-month').value;
        const [year, month] = selectedMonth.split('/').map(Number);
        const now = new Date();
        const timestamp = new Date(year, month - 1, now.getDate(), now.getHours(), now.getMinutes()).getTime();

        records.push({ date: new Date(timestamp).toLocaleDateString('zh-TW'), note: "校正紀錄", amount: Math.abs(diff), type: diff > 0 ? 'in' : 'out', timestamp: timestamp });
        document.getElementById('manual-adjust-val').value = '';
        saveAndRefresh();
    }

    function addRecord() {
        const amtInput = document.getElementById('spend-amount');
        const noteInput = document.getElementById('spend-note');
        if (isNaN(parseFloat(amtInput.value))) return;
        const selectedMonth = document.getElementById('view-month').value;
        const [year, month] = selectedMonth.split('/').map(Number);
        const now = new Date();
        const timestamp = new Date(year, month - 1, now.getDate(), now.getHours(), now.getMinutes()).getTime();

        records.push({ date: new Date(timestamp).toLocaleDateString('zh-TW'), note: noteInput.value || (currentType === 'in' ? "收入" : "支出"), amount: parseFloat(amtInput.value), type: currentType, timestamp: timestamp });
        saveAndRefresh();
        amtInput.value = ''; noteInput.value = '';
    }

    function deleteRecord(timestamp) { if (confirm("要刪除嗎？")) { records = records.filter(r => r.timestamp !== timestamp); saveAndRefresh(); } }
    function saveAndRefresh() { localStorage.setItem('budget_records_v12', JSON.stringify(records)); calculate(); }

    function renderHistory(data, limit) {
        const list = document.getElementById('history-list'); list.innerHTML = '';
        let dayOutTotals = {};
        const sorted = [...data].sort((a, b) => a.timestamp - b.timestamp);
        const processed = sorted.map(r => {
            if (r.type === 'out') {
                dayOutTotals[r.date] = (dayOutTotals[r.date] || 0) + r.amount;
                return { ...r, dayTotal: dayOutTotals[r.date] };
            }
            return r;
        });
        processed.reverse().forEach(r => {
            let rightHTML = '';
            if (r.type === 'out') {
                const diff = limit - r.dayTotal;
                rightHTML = `<div class="txt-red">-$${r.amount} <span class="diff-tag ${diff>=0?'diff-pos':'diff-neg'}">(${diff>=0?'+':''}${diff})</span></div>`;
            } else {
                rightHTML = `<div class="txt-green">+$${r.amount} <span class="diff-tag txt-green">(收入)</span></div>`;
            }
            list.innerHTML += `<div class="history-item"><div class="date-info"><span class="date-tag">${r.date}</span><span class="note-text">${r.note}</span></div><div class="item-right">${rightHTML}<button class="delete-btn" onclick="deleteRecord(${r.timestamp})">✕</button></div></div>`;
        });
    }

    function exportData() {
        const blob = new Blob([JSON.stringify({records, settings})], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = '摳摳守護者備份.json'; a.click();
    }
    function importData() { document.getElementById('importFile').click(); }
    function handleFileSelect(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            try { 
                const imported = JSON.parse(event.target.result);
                records = imported.records || [];
                settings = imported.settings || {};
                localStorage.setItem('budget_records_v12', JSON.stringify(records));
                localStorage.setItem('budget_settings_v12', JSON.stringify(settings));
                loadCurrentMonthSettings(); calculate(); alert("備份已還原");
            } catch(e) { alert("檔案格式錯誤"); }
        };
        reader.readAsText(e.target.files[0]);
    }
    function clearData() { if (confirm("確定清空所有月份？")) { records = []; settings = {}; localStorage.clear(); loadCurrentMonthSettings(); calculate(); } }

    initMonthSelector();
    loadCurrentMonthSettings();
    calculate();
</script>
</body>
</html>
